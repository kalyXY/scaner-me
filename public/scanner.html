<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Scanner QR - Syst√®me de Pr√©sence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        h1 {
            color: #4a5568;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        .scanner-section {
            margin-bottom: 2rem;
        }

        #video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border-radius: 10px;
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            object-fit: cover;
        }

        .scanner-overlay {
            position: relative;
            display: inline-block;
        }

        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #48bb78;
            border-radius: 10px;
            pointer-events: none;
        }

        .scanner-frame::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 3px solid rgba(72, 187, 120, 0.3);
            border-radius: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .controls {
            margin: 1.5rem 0;
        }

        .btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 0.5rem;
        }

        .btn:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .btn.secondary {
            background: #4299e1;
        }

        .btn.secondary:hover {
            background: #3182ce;
        }

        .status {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 500;
        }

        .status.success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .status.warning {
            background: #fefcbf;
            color: #744210;
            border: 1px solid #f6e05e;
        }

        .status.info {
            background: #ebf8ff;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }

        .student-info {
            background: #f7fafc;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            border: 1px solid #e2e8f0;
        }

        .student-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #718096;
        }

        .student-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .attendance-status {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-present {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-late {
            background: #fed7aa;
            color: #9c4221;
        }

        .status-exam-allowed {
            background: #bee3f8;
            color: #2a4365;
        }

        .status-exam-denied {
            background: #fed7d7;
            color: #742a2a;
        }

        .manual-input {
            margin-top: 1rem;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .manual-input input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #48bb78;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        @media (max-width: 600px) {
            .container {
                padding: 1.5rem;
                margin: 1rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            #video {
                height: 250px;
            }
            
            .scanner-frame {
                width: 150px;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì Scanner QR - Pr√©sence</h1>
        
        <div class="scanner-section">
            <div class="scanner-overlay">
                <video id="video" autoplay muted playsinline></video>
                <div class="scanner-frame"></div>
            </div>
        </div>

        <div class="controls">
            <button id="startBtn" class="btn">üì∑ D√©marrer Scanner</button>
            <button id="stopBtn" class="btn secondary hidden">‚èπÔ∏è Arr√™ter</button>
            <button id="manualBtn" class="btn secondary">‚úèÔ∏è Saisie Manuelle</button>
        </div>

        <div id="status" class="hidden"></div>

        <div id="studentInfo" class="student-info hidden">
            <div class="student-photo" id="studentPhoto">üë§</div>
            <div class="student-name" id="studentName"></div>
            <div id="attendanceInfo"></div>
        </div>

        <div id="manualInput" class="manual-input hidden">
            <h3>Saisie manuelle UUID</h3>
            <input type="text" id="manualUuid" placeholder="Entrez l'UUID de l'√©tudiant">
            <button id="submitManual" class="btn">Valider</button>
        </div>

        <div style="margin-top: 2rem;">
            <a href="dashboard.php" class="btn secondary">üìä Tableau de bord</a>
        </div>
    </div>

    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    
    <script>
        class AttendanceScanner {
            constructor() {
                this.qrScanner = null;
                this.videoElement = document.getElementById('video');
                this.isScanning = false;
                this.lastScanTime = 0;
                this.scanCooldown = 3000; // 3 seconds cooldown between scans
                
                this.initializeElements();
                this.attachEventListeners();
            }

            initializeElements() {
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.manualBtn = document.getElementById('manualBtn');
                this.statusDiv = document.getElementById('status');
                this.studentInfo = document.getElementById('studentInfo');
                this.manualInput = document.getElementById('manualInput');
                this.manualUuid = document.getElementById('manualUuid');
                this.submitManual = document.getElementById('submitManual');
            }

            attachEventListeners() {
                this.startBtn.addEventListener('click', () => this.startScanning());
                this.stopBtn.addEventListener('click', () => this.stopScanning());
                this.manualBtn.addEventListener('click', () => this.toggleManualInput());
                this.submitManual.addEventListener('click', () => this.submitManualUuid());
                
                // Handle Enter key in manual input
                this.manualUuid.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.submitManualUuid();
                    }
                });
            }

            async startScanning() {
                try {
                    this.showStatus('Initialisation de la cam√©ra...', 'info');
                    
                    // Import QrScanner dynamically
                    if (typeof QrScanner === 'undefined') {
                        throw new Error('QR Scanner library not loaded');
                    }

                    this.qrScanner = new QrScanner(
                        this.videoElement,
                        (result) => this.onScanResult(result),
                        {
                            highlightScanRegion: true,
                            highlightCodeOutline: true,
                        }
                    );

                    await this.qrScanner.start();
                    
                    this.isScanning = true;
                    this.startBtn.classList.add('hidden');
                    this.stopBtn.classList.remove('hidden');
                    this.hideStatus();
                    
                } catch (error) {
                    console.error('Error starting scanner:', error);
                    this.showStatus('Erreur: Impossible d\'acc√©der √† la cam√©ra. V√©rifiez les permissions.', 'error');
                }
            }

            stopScanning() {
                if (this.qrScanner) {
                    this.qrScanner.stop();
                    this.qrScanner.destroy();
                    this.qrScanner = null;
                }
                
                this.isScanning = false;
                this.startBtn.classList.remove('hidden');
                this.stopBtn.classList.add('hidden');
                this.showStatus('Scanner arr√™t√©', 'info');
            }

            onScanResult(result) {
                const now = Date.now();
                if (now - this.lastScanTime < this.scanCooldown) {
                    return; // Cooldown period
                }
                
                this.lastScanTime = now;
                
                let uuid = null;
                
                // Extract UUID from QR code result
                if (result.data) {
                    const url = result.data;
                    const uuidMatch = url.match(/uuid=([a-f0-9-]{36})/i);
                    if (uuidMatch) {
                        uuid = uuidMatch[1];
                    } else {
                        // Maybe it's just the UUID directly
                        const directUuidMatch = url.match(/^[a-f0-9-]{36}$/i);
                        if (directUuidMatch) {
                            uuid = url;
                        }
                    }
                }

                if (uuid) {
                    this.processAttendance(uuid);
                } else {
                    this.showStatus('QR Code invalide. Veuillez r√©essayer.', 'error');
                }
            }

            async processAttendance(uuid) {
                try {
                    this.showStatus('Traitement en cours...', 'info', true);
                    
                    const response = await fetch('/api/scan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ uuid: uuid })
                    });

                    const data = await response.json();

                    if (data.ok) {
                        this.displayStudentInfo(data);
                        this.showStatus('Pr√©sence enregistr√©e avec succ√®s!', 'success');
                    } else {
                        this.showStatus(data.error || 'Erreur lors de l\'enregistrement', 'error');
                        this.hideStudentInfo();
                    }

                } catch (error) {
                    console.error('Error processing attendance:', error);
                    this.showStatus('Erreur de connexion au serveur', 'error');
                    this.hideStudentInfo();
                }
            }

            displayStudentInfo(data) {
                const student = data.student;
                const session = data.session;
                const attendance = data.attendance;
                const exam = data.exam;

                // Update student name
                document.getElementById('studentName').textContent = student.name;

                // Update photo (placeholder for now)
                document.getElementById('studentPhoto').textContent = student.name.charAt(0).toUpperCase();

                // Create attendance info
                let attendanceHtml = '';
                
                if (session.is_exam && exam) {
                    if (exam.allowed) {
                        attendanceHtml = `
                            <div class="attendance-status status-exam-allowed">‚úÖ Examen Autoris√©</div>
                            <p style="margin-top: 0.5rem; color: #2d3748;">
                                <strong>Examen:</strong> ${session.course}<br>
                                <strong>Date:</strong> ${session.date}<br>
                                <strong>Heure:</strong> ${session.start_time}
                            </p>
                        `;
                    } else {
                        attendanceHtml = `
                            <div class="attendance-status status-exam-denied">‚ùå Acc√®s Refus√©</div>
                            <p style="margin-top: 0.5rem; color: #742a2a;">
                                Frais d'examen non pay√©s
                            </p>
                        `;
                    }
                } else {
                    const statusClass = attendance.status === 'present' ? 'status-present' : 'status-late';
                    const statusIcon = attendance.status === 'present' ? '‚úÖ' : '‚è∞';
                    const statusText = attendance.status === 'present' ? 'Pr√©sent' : 'En Retard';
                    
                    attendanceHtml = `
                        <div class="attendance-status ${statusClass}">${statusIcon} ${statusText}</div>
                        <p style="margin-top: 0.5rem; color: #2d3748;">
                            <strong>Cours:</strong> ${session.course}<br>
                            <strong>Date:</strong> ${session.date}<br>
                            <strong>Heure:</strong> ${session.start_time}
                        </p>
                    `;
                }

                document.getElementById('attendanceInfo').innerHTML = attendanceHtml;
                this.studentInfo.classList.remove('hidden');

                // Hide student info after 5 seconds
                setTimeout(() => {
                    this.hideStudentInfo();
                }, 5000);
            }

            hideStudentInfo() {
                this.studentInfo.classList.add('hidden');
            }

            toggleManualInput() {
                this.manualInput.classList.toggle('hidden');
                if (!this.manualInput.classList.contains('hidden')) {
                    this.manualUuid.focus();
                }
            }

            submitManualUuid() {
                const uuid = this.manualUuid.value.trim();
                if (uuid) {
                    this.processAttendance(uuid);
                    this.manualUuid.value = '';
                    this.manualInput.classList.add('hidden');
                }
            }

            showStatus(message, type = 'info', showLoading = false) {
                this.statusDiv.className = `status ${type}`;
                this.statusDiv.innerHTML = showLoading ? 
                    `<span class="loading"></span>${message}` : 
                    message;
                this.statusDiv.classList.remove('hidden');
            }

            hideStatus() {
                this.statusDiv.classList.add('hidden');
            }
        }

        // Initialize scanner when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new AttendanceScanner();
        });
    </script>
</body>
</html>